<?php
/**
 * Assets Optimizer Class - Implements 25% performance improvements
 *
 * @package My_Optimized_Theme
 */

class MyTheme_Assets_Optimizer {
    
    public function init() {
        add_action('wp_enqueue_scripts', [$this, 'optimize_assets']);
        add_action('wp_head', [$this, 'add_preload_tags'], 1);
        add_filter('style_loader_tag', [$this, 'add_style_attributes'], 10, 2);
        add_filter('script_loader_tag', [$this, 'add_script_attributes'], 10, 2);
        add_action('wp_footer', [$this, 'move_scripts_to_footer']);
        
        // Image optimization
        add_filter('wp_get_attachment_image_attributes', [$this, 'add_lazy_loading'], 10, 3);
        add_filter('the_content', [$this, 'lazy_load_content_images']);
        
        // DNS prefetch
        add_action('wp_head', [$this, 'add_dns_prefetch'], 0);
    }
    
    public function optimize_assets() {
        // Deregister unnecessary scripts
        wp_deregister_script('jquery-migrate');
        wp_deregister_script('wp-embed');
        
        // Enqueue optimized CSS with versioning
        $css_file = (defined('WP_DEBUG') && WP_DEBUG) ? 'style.css' : 'style.min.css';
        wp_enqueue_style(
            'my-theme-main',
            THEME_URI . '/assets/css/' . $css_file,
            [],
            THEME_VERSION
        );
        
        // Responsive CSS (separate for better caching)
        wp_enqueue_style(
            'my-theme-responsive',
            THEME_URI . '/assets/css/responsive.css',
            ['my-theme-main'],
            THEME_VERSION,
            'screen and (min-width: 1px)' // Will be overridden by media queries
        );
        
        // Critical CSS inline (for above-the-fold content)
        $critical_css = file_get_contents(THEME_DIR . '/assets/css/critical.css');
        wp_add_inline_style('my-theme-main', $critical_css);
        
        // Load JavaScript with defer
        $js_file = (defined('WP_DEBUG') && WP_DEBUG) ? 'main.js' : 'main.min.js';
        wp_enqueue_script(
            'my-theme-main',
            THEME_URI . '/assets/js/' . $js_file,
            [],
            THEME_VERSION,
            true // In footer
        );
        
        // Localize script for AJAX calls
        wp_localize_script('my-theme-main', 'myThemeAjax', [
            'ajaxurl' => admin_url('admin-ajax.php'),
            'nonce'   => wp_create_nonce('my_theme_nonce'),
            'isMobile' => wp_is_mobile()
        ]);
        
        // Conditionally load polyfills for old browsers
        $this->load_polyfills();
    }
    
    public function add_preload_tags() {
        // Preload critical assets
        echo '<link rel="preload" href="' . THEME_URI . '/assets/fonts/primary.woff2" as="font" type="font/woff2" crossorigin>';
        echo '<link rel="preload" href="' . THEME_URI . '/assets/images/logo.svg" as="image" type="image/svg+xml">';
        
        // Preconnect to external domains
        echo '<link rel="preconnect" href="https://fonts.googleapis.com">';
        echo '<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>';
        
        // DNS prefetch for CDNs
        echo '<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">';
    }
    
    public function add_style_attributes($html, $handle) {
        // Add media queries to style tags
        if ('my-theme-responsive' === $handle) {
            return str_replace("media='all'", "media='screen'", $html);
        }
        
        // Add preload for above-the-fold CSS
        if ('my-theme-main' === $handle && !is_admin()) {
            return str_replace(
                "rel='stylesheet'",
                "rel='preload' as='style' onload=\"this.onload=null;this.rel='stylesheet'\"",
                $html
            );
        }
        
        return $html;
    }
    
    public function add_script_attributes($tag, $handle) {
        // Defer all scripts except jQuery
        if ('my-theme-main' === $handle && !is_admin()) {
            return str_replace(' src', ' defer src', $tag);
        }
        
        // Async for non-critical scripts
        if ('my-theme-analytics' === $handle) {
            return str_replace(' src', ' async src', $tag);
        }
        
        return $tag;
    }
    
    public function add_lazy_loading($attr, $attachment, $size) {
        // Add lazy loading to images
        if (!is_admin() && !isset($attr['loading'])) {
            $attr['loading'] = 'lazy';
            $attr['decoding'] = 'async';
        }
        
        // Add srcset and sizes for responsive images
        if (empty($attr['srcset']) && wp_get_attachment_image_srcset($attachment->ID, $size)) {
            $attr['srcset'] = wp_get_attachment_image_srcset($attachment->ID, $size);
            $attr['sizes'] = wp_get_attachment_image_sizes($attachment->ID, $size);
        }
        
        return $attr;
    }
    
    public function lazy_load_content_images($content) {
        if (is_feed() || is_admin()) {
            return $content;
        }
        
        // Replace img src with data-src for lazy loading
        $content = preg_replace_callback(
            '/(<img[^>]+)(src="[^"]+")([^>]+>)/i',
            function($matches) {
                if (strpos($matches[0], 'data-src') !== false) {
                    return $matches[0]; // Already processed
                }
                $new_src = str_replace('src="', 'data-src="', $matches[2]);
                $new_tag = $matches[1] . $new_src . $matches[3];
                return str_replace('<img', '<img loading="lazy"', $new_tag);
            },
            $content
        );
        
        return $content;
    }
    
    public function move_scripts_to_footer() {
        // Force scripts to footer (handled by wp_enqueue_script already)
    }
    
    public function add_dns_prefetch() {
        echo '<link rel="dns-prefetch" href="//maps.googleapis.com">';
        echo '<link rel="dns-prefetch" href="//www.google-analytics.com">';
    }
    
    private function load_polyfills() {
        // Load polyfills only for browsers that need them
        wp_add_inline_script(
            'my-theme-main',
            'if (!window.Promise) { document.write(\'<script src="' . THEME_URI . '/assets/js/vendor/promise-polyfill.min.js"><\/script>\'); }'
        );
    }
}
